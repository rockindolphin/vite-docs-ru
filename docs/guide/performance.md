# Производительность

Хотя Vite по умолчанию быстрый, проблемы с производительностью могут возникнуть по мере роста требований проекта. Этот гид направлен на то, чтобы помочь вам выявить и исправить общие проблемы с производительностью, такие как:

- Медленный запуск сервера
- Медленная загрузка страниц
- Медленные сборки

## Проверьте настройки вашего браузера

Некоторые расширения браузера могут мешать запросам и замедлять время запуска и перезагрузки для крупных приложений, особенно при использовании инструментов разработчика браузера. Мы рекомендуем создать профиль только для разработки без расширений или переключиться в режим инкогнито, используя dev-сервер Vite в этих случаях. Режим инкогнито также должен быть быстрее, чем обычный профиль без расширений.

Dev-сервер Vite выполняет жесткое кэширование предварительно собранных зависимостей и реализует быстрые 304 ответы для исходного кода. Отключение кэша, пока инструменты разработчика браузера открыты, может значительно повлиять на время запуска и полную перезагрузку страницы. Пожалуйста, убедитесь, что "Отключить кэш" не включено, пока вы работаете с сервером Vite.

## Проверьте настроенные плагины Vite

Внутренние и официальные плагины Vite оптимизированы для выполнения минимального объема работы, обеспечивая совместимость с более широкой экосистемой. Например, преобразования кода используют регулярные выражения в режиме разработки, но выполняют полный парсинг при сборке для обеспечения корректности.

Однако производительность плагинов сообщества находится вне контроля Vite, что может повлиять на опыт разработчика. Вот несколько вещей, на которые стоит обратить внимание при использовании дополнительных плагинов Vite:

1. Большие зависимости, которые используются только в определенных случаях, следует динамически импортировать, чтобы сократить время запуска Node.js. Примеры рефакторинга: [vite-plugin-react#212](https://github.com/vitejs/vite-plugin-react/pull/212) и [vite-plugin-pwa#224](https://github.com/vite-pwa/vite-plugin-pwa/pull/244).

2. Хуки `buildStart`, `config` и `configResolved` не должны выполнять длительные и обширные операции. Эти хуки ожидаются во время запуска dev-сервера, что задерживает доступ к сайту в браузере.

3. Хуки `resolveId`, `load` и `transform` могут вызывать медленную загрузку некоторых файлов. Хотя это иногда неизбежно, все же стоит проверить возможные области для оптимизации. Например, проверьте, содержит ли `code` определенное ключевое слово, или совпадает ли `id` с определенным расширением, прежде чем выполнять полное преобразование.

   Чем дольше занимает преобразование файла, тем значительнее будет водопад запросов при загрузке сайта в браузере.

   Вы можете проверить продолжительность преобразования файла, используя `vite --debug plugin-transform` или [vite-plugin-inspect](https://github.com/antfu/vite-plugin-inspect). Обратите внимание, что асинхронные операции, как правило, предоставляют неточные временные показатели, поэтому следует рассматривать эти цифры как приблизительные, но они все равно должны выявить более дорогие операции.

::: tip Профилирование
Вы можете запустить `vite --profile`, посетить сайт и нажать `p + enter` в вашем терминале, чтобы записать `.cpuprofile`. Инструмент, такой как [speedscope](https://www.speedscope.app), может быть использован для анализа профиля и выявления узких мест. Вы также можете [поделиться профилями](https://chat.vite.dev) с командой Vite, чтобы помочь нам выявить проблемы с производительностью.
:::

## Уменьшите операции разрешения

Разрешение импортных путей может быть дорогостоящей операцией, когда она часто достигает своего худшего случая. Например, Vite поддерживает "угадывание" импортных путей с помощью опции [`resolve.extensions`](/config/shared-options.md#resolve-extensions), которая по умолчанию установлена в `['.mjs', '.js', '.mts', '.ts', '.jsx', '.tsx', '.json']`.

Когда вы пытаетесь импортировать `./Component.jsx` с помощью `import './Component'`, Vite выполнит следующие шаги для его разрешения:

1. Проверьте, существует ли `./Component`, нет.
2. Проверьте, существует ли `./Component.mjs`, нет.
3. Проверьте, существует ли `./Component.js`, нет.
4. Проверьте, существует ли `./Component.mts`, нет.
5. Проверьте, существует ли `./Component.ts`, нет.
6. Проверьте, существует ли `./Component.jsx`, да!

Как видно, для разрешения импортного пути требуется всего 6 проверок файловой системы. Чем больше неявных импортов у вас есть, тем больше времени потребуется для их разрешения.

Поэтому обычно лучше быть явным с вашими импортными путями, например, `import './Component.jsx'`. Вы также можете сузить список для `resolve.extensions`, чтобы уменьшить общие проверки файловой системы, но вы должны убедиться, что это работает и для файлов в `node_modules`.

Если вы автор плагина, убедитесь, что вы вызываете [`this.resolve`](https://rollupjs.org/plugin-development/#this-resolve) только по мере необходимости, чтобы уменьшить количество проверок выше.

::: tip TypeScript
Если вы используете TypeScript, включите `"moduleResolution": "bundler"` и `"allowImportingTsExtensions": true` в `compilerOptions` вашего `tsconfig.json`, чтобы использовать `.ts` и `.tsx` расширения напрямую в вашем коде.
:::

## Избегайте файлов-бочонков

Файлы-бочонки - это файлы, которые повторно экспортируют API других файлов в той же директории. Например:

```js [src/utils/index.js]
export * from './color.js'
export * from './dom.js'
export * from './slash.js'
```

Когда вы импортируете только отдельный API, например, `import { slash } from './utils'`, все файлы в этом файле-бочонке должны быть загружены и преобразованы, так как они могут содержать API `slash` и могут также содержать побочные эффекты, которые выполняются при инициализации. Это означает, что вы загружаете больше файлов, чем требуется, при первоначальной загрузке страницы, что приводит к более медленной загрузке страницы.

Если возможно, вы должны избегать файлов-бочонков и импортировать отдельные API напрямую, например, `import { slash } from './utils/slash.js'`. Вы можете прочитать [issue #8237](https://github.com/vitejs/vite/issues/8237) для получения дополнительной информации.

## Разогревайте часто используемые файлы

Dev-сервер Vite преобразует файлы только по запросу браузера, что позволяет ему быстро запускаться и применять преобразования только для используемых файлов. Он также может предварительно преобразовать файлы, если предполагает, что некоторые файлы будут запрашиваться в ближайшее время. Однако водопады запросов могут все еще происходить, если некоторые файлы требуют больше времени для преобразования, чем другие. Например:

Учитывая граф импорта, где левый файл импортирует правый файл:

```
main.js -> BigComponent.vue -> big-utils.js -> large-data.json
```

Отношение импорта может быть известно только после преобразования файла. Если `BigComponent.vue` требует много времени для преобразования, `big-utils.js` должен ждать своей очереди, и так далее. Это вызывает внутренний водопад даже с предварительным преобразованием, встроенным в систему.

Vite позволяет вам разогревать файлы, которые вы знаете, что часто используются, например, `big-utils.js`, с помощью опции [`server.warmup`](/config/server-options.md#server-warmup). Это позволяет `big-utils.js` быть готовым и кэшированным, чтобы быть немедленно обслуженным при запросе.

Вы можете найти часто используемые файлы, запустив `vite --debug transform` и проверив логи:

```bash
vite:transform 28.72ms /@vite/client +1ms
vite:transform 62.95ms /src/components/BigComponent.vue +1ms
vite:transform 102.54ms /src/utils/big-utils.js +1ms
```

```js [vite.config.js]
export default defineConfig({
  server: {
    warmup: {
      clientFiles: [
        './src/components/BigComponent.vue',
        './src/utils/big-utils.js',
      ],
    },
  },
})
```

Обратите внимание, что вы должны разогревать только те файлы, которые часто используются, чтобы не перегружать dev-сервер Vite при запуске. Проверьте [`server.warmup`](/config/server-options.md#server-warmup) опцию для получения дополнительной информации.

Использование [`--open` или `server.open`](/config/server-options.html#server-open) также обеспечивает прирост производительности, так как Vite автоматически разогревает точку входа вашего приложения или предоставленный URL для открытия.

## Используйте меньше или используйте собственные инструменты

Сохранение Vite быстрым с растущим кодом-основой - это о сокращении количества работы для исходных файлов (JS/TS/CSS).

Примеры выполнения меньшей работы:

- Используйте CSS вместо Sass/Less/Stylus, когда это возможно (вложенность может быть обработана PostCSS)
- Не преобразовывайте SVG в компоненты UI-фреймворка (React, Vue, etc). Импортируйте их как строки или URL вместо этого.
- Когда используете `@vitejs/plugin-react`, избегайте настройки опций Babel, так что оно пропускает преобразование во время сборки (только esbuild будет использоваться).

Примеры использования собственных инструментов:

Использование собственных инструментов часто приводит к большему размеру установки и, как следствие, не является стандартным при создании нового проекта Vite. Но это может стоить затрат для более крупных приложений.

- Используйте [Rolldown вместо Rollup и esbuild](./rolldown) для более быстрых сборки и более согласованного опыта между dev и build.
- Попробуйте экспериментальную поддержку [LightningCSS](https://github.com/vitejs/vite/discussions/13835)
- Используйте [`@vitejs/plugin-react-swc`](https://github.com/vitejs/vite-plugin-react-swc) вместо `@vitejs/plugin-react`.
