# Предварительная сборка зависимостей

Когда вы впервые запускаете `vite`, Vite предварительно собирает зависимости вашего проекта перед локальной загрузкой сайта. Это делается автоматически и прозрачно по умолчанию.

## Почему это нужно

Это Vite выполняет то, что мы называем "предварительной сборкой зависимостей". Этот процесс служит двум целям:

1. **Совместимость с CommonJS и UMD:** Во время разработки dev-сервер Vite обслуживает весь код как нативный ESM. Поэтому Vite должен сначала преобразовать зависимости, которые поставляются как CommonJS или UMD, в ESM.

   При преобразовании зависимостей CommonJS Vite выполняет умный анализ импортов, чтобы именованные импорты в модули CommonJS работали как ожидается, даже если экспорты назначаются динамически (например, React):

   ```js
   // работает как ожидается
   import React, { useState } from 'react'
   ```

2. **Производительность:** Vite преобразует ESM-зависимости со многими внутренними модулями в один модуль для улучшения последующей производительности загрузки страницы.

   Некоторые пакеты поставляют свои сборки ES модулей как множество отдельных файлов, импортирующих друг друга. Например, [`lodash-es` имеет более 600 внутренних модулей](https://unpkg.com/browse/lodash-es/)! Когда мы делаем `import { debounce } from 'lodash-es'`, браузер отправляет более 600 HTTP-запросов одновременно! Даже если сервер не имеет проблем с их обработкой, большое количество запросов создает сетевую перегрузку на стороне браузера, что приводит к заметному замедлению загрузки страницы.

   Предварительно собирая `lodash-es` в один модуль, нам теперь нужен только один HTTP-запрос!

::: tip ПРИМЕЧАНИЕ
Предварительная сборка зависимостей применяется только в режиме разработки и использует `esbuild` для преобразования зависимостей в ESM. В production-сборках вместо этого используется `@rollup/plugin-commonjs`.
:::

## Автоматическое обнаружение зависимостей

Если существующий кэш не найден, Vite просканирует ваш исходный код и автоматически обнаружит импорты зависимостей (т.е. "голые импорты", которые должны разрешаться из `node_modules`) и использует эти найденные импорты как точки входа для предварительной сборки. Предварительная сборка выполняется с помощью `esbuild`, поэтому она обычно очень быстрая.

После того, как сервер уже запущен, если встречается новый импорт зависимости, которого еще нет в кэше, Vite повторно запустит процесс сборки зависимостей и перезагрузит страницу при необходимости.

## Монорепозитории и связанные зависимости

В настройке монорепозитория зависимость может быть связанным пакетом из того же репозитория. Vite автоматически обнаруживает зависимости, которые не разрешаются из `node_modules`, и обрабатывает связанную зависимость как исходный код. Он не будет пытаться собрать связанную зависимость, а вместо этого проанализирует список зависимостей связанной зависимости.

Однако это требует, чтобы связанная зависимость экспортировалась как ESM. Если нет, вы можете добавить зависимость в [`optimizeDeps.include`](/config/dep-optimization-options.md#optimizedeps-include) и [`build.commonjsOptions.include`](/config/build-options.md#build-commonjsoptions) в вашей конфигурации.

```js twoslash [vite.config.js]
import { defineConfig } from 'vite'
// ---cut---
export default defineConfig({
  optimizeDeps: {
    include: ['linked-dep'],
  },
  build: {
    commonjsOptions: {
      include: [/linked-dep/, /node_modules/],
    },
  },
})
```

При внесении изменений в связанную зависимость перезапустите dev-сервер с опцией командной строки `--force`, чтобы изменения вступили в силу.

## Настройка поведения

Эвристика обнаружения зависимостей по умолчанию может не всегда быть желательной. В случаях, когда вы хотите явно включить/исключить зависимости из списка, используйте [опции конфигурации `optimizeDeps`](/config/dep-optimization-options.md).

Типичный случай использования `optimizeDeps.include` или `optimizeDeps.exclude` - это когда у вас есть импорт, который не может быть непосредственно обнаружен в исходном коде. Например, возможно, импорт создается в результате трансформации плагина. Это означает, что Vite не сможет обнаружить импорт при начальном сканировании - он может обнаружить его только после того, как файл запрашивается браузером и трансформируется. Это вызовет немедленную пересборку после запуска сервера.

Оба параметра `include` и `exclude` можно использовать для решения этой проблемы. Если зависимость большая (со многими внутренними модулями) или является CommonJS, то вы должны включить её; Если зависимость маленькая и уже является валидным ESM, вы можете исключить её и позволить браузеру загружать её напрямую.

Вы также можете дополнительно настроить esbuild с помощью [опции `optimizeDeps.esbuildOptions`](/config/dep-optimization-options.md#optimizedeps-esbuildoptions). Например, добавление плагина esbuild для обработки специальных файлов в зависимостях или изменение [цели сборки `target`](https://esbuild.github.io/api/#target).

## Кэширование

### Кэш файловой системы

Vite кэширует предварительно собранные зависимости в `node_modules/.vite`. Он определяет, нужно ли повторно выполнять шаг предварительной сборки, основываясь на нескольких источниках:

- Содержимое файла блокировки менеджера пакетов, например, `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml` или `bun.lockb`.
- Время модификации папки с патчами.
- Соответствующие поля в вашем `vite.config.js`, если они присутствуют.
- Значение `NODE_ENV`.

Шаг предварительной сборки нужно будет повторно выполнить только когда один из вышеперечисленных параметров изменится.

Если по какой-то причине вы хотите принудительно заставить Vite пересобрать зависимости, вы можете либо запустить dev-сервер с опцией командной строки `--force`, либо вручную удалить кэш-директорию `node_modules/.vite`.

### Кэш браузера

Разрешенные запросы зависимостей сильно кэшируются с HTTP-заголовками `max-age=31536000,immutable` для улучшения производительности перезагрузки страницы во время разработки. После кэширования эти запросы никогда больше не попадут на dev-сервер. Они автоматически инвалидируются добавленным версионным запросом, если установлена другая версия (как отражено в файле блокировки вашего менеджера пакетов). Если вы хотите отладить ваши зависимости, внося локальные изменения, вы можете:

1. Временно отключить кэш через вкладку Network в инструментах разработчика браузера;
2. Перезапустить dev-сервер Vite с флагом `--force` для пересборки зависимостей;
3. Перезагрузить страницу.
