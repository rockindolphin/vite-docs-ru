# API окружений

:::warning Экспериментально
API окружений является экспериментальным. Мы будем поддерживать API стабильным во время Vite 6, чтобы позволить экосистеме экспериментировать и строить на его основе. Мы планируем стабилизировать эти новые API с потенциальными breaking changes в Vite 7.

Ресурсы:

- [Обсуждение обратной связи](https://github.com/vitejs/vite/discussions/16358), где мы собираем отзывы о новых API.
- [PR API окружений](https://github.com/vitejs/vite/pull/16471), где новые API были реализованы и проверены.

Пожалуйста, поделитесь с нами вашими отзывами.
:::

## Формализация окружений

Vite 6 формализует концепцию окружений. До Vite 5 существовали два неявных окружения (`client` и опционально `ssr`). Новый API окружений позволяет пользователям и авторам фреймворков создавать столько окружений, сколько необходимо для отображения того, как их приложения работают в продакшене. Эта новая возможность потребовала большого внутреннего рефакторинга, но много усилий было приложено для обеспечения обратной совместимости. Первоначальная цель Vite 6 - как можно более плавно перевести экосистему на новую мажорную версию, отложив принятие этих новых экспериментальных API до тех пор, пока достаточно пользователей не мигрируют, а авторы фреймворков и плагинов не проверят новый дизайн.

## Устранение разрыва между сборкой и разработкой

Для простого SPA/MPA новые API вокруг окружений не раскрываются в конфигурации. Внутренне Vite применит опции к окружению `client`, но нет необходимости знать об этой концепции при настройке Vite. Конфигурация и поведение из Vite 5 должны работать здесь бесшовно.

Когда мы переходим к типичному серверному приложению с рендерингом (SSR), у нас будет два окружения:

- `client`: запускает приложение в браузере.
- `server`: запускает приложение в node (или других серверных средах выполнения), которые рендерят страницы перед отправкой их в браузер.

В режиме разработки Vite выполняет серверный код в том же процессе Node, что и dev-сервер Vite, давая близкое приближение к продакшен-окружению. Однако также возможно запускать серверы в других JS-средах выполнения, таких как [Cloudflare's workerd](https://github.com/cloudflare/workerd), которые имеют разные ограничения. Современные приложения могут также работать более чем в двух окружениях, например, в браузере, node-сервере и edge-сервере. Vite 5 не позволял правильно представлять эти окружения.

Vite 6 позволяет пользователям настраивать их приложение во время сборки и разработки для отображения всех его окружений. Во время разработки один dev-сервер Vite теперь может использоваться для запуска кода в нескольких разных окружениях одновременно. Исходный код приложения все еще преобразуется dev-сервером Vite. Поверх общего HTTP-сервера, middleware, разрешенной конфигурации и пайплайна плагинов, dev-сервер Vite теперь имеет набор независимых dev-окружений. Каждое из них настроено для максимально близкого соответствия продакшен-окружению и подключено к dev-среде выполнения, где выполняется код (для workerd серверный код теперь может выполняться локально в miniflare). В клиенте браузер импортирует и выполняет код. В других окружениях модульный загрузчик получает и оценивает преобразованный код.

![Окружения Vite](../images/vite-environments.svg)

## Конфигурация окружений

Для SPA/MPA конфигурация будет выглядеть похоже на Vite 5. Внутренне эти опции используются для настройки окружения `client`.

```js
export default defineConfig({
  build: {
    sourcemap: false,
  },
  optimizeDeps: {
    include: ['lib'],
  },
})
```

Это важно, потому что мы хотим сохранить Vite доступным и избегать раскрытия новых концепций, пока они не нужны.

Если приложение состоит из нескольких окружений, то эти окружения могут быть явно настроены с помощью опции конфигурации `environments`.

```js
export default {
  build: {
    sourcemap: false,
  },
  optimizeDeps: {
    include: ['lib'],
  },
  environments: {
    server: {},
    edge: {
      resolve: {
        noExternal: true,
      },
    },
  },
}
```

Когда явно не документировано, окружение наследует настроенные опции верхнего уровня конфигурации (например, новые окружения `server` и `edge` унаследуют опцию `build.sourcemap: false`). Небольшое количество опций верхнего уровня, таких как `optimizeDeps`, применяется только к окружению `client`, так как они не работают хорошо при применении по умолчанию к серверным окружениям. Окружение `client` также может быть явно настроено через `environments.client`, но мы рекомендуем делать это с помощью опций верхнего уровня, чтобы конфигурация клиента оставалась неизменной при добавлении новых окружений.

Интерфейс `EnvironmentOptions` раскрывает все опции для каждого окружения. Есть опции окружения, которые применяются как к `build`, так и к `dev`, такие как `resolve`. И есть `DevEnvironmentOptions` и `BuildEnvironmentOptions` для специфичных для dev и build опций (таких как `dev.warmup` или `build.outDir`). Некоторые опции, такие как `optimizeDeps`, применяются только к dev, но сохраняются на верхнем уровне вместо вложенности в `dev` для обратной совместимости.

```ts
interface EnvironmentOptions {
  define?: Record<string, any>
  resolve?: EnvironmentResolveOptions
  optimizeDeps: DepOptimizationOptions
  consumer?: 'client' | 'server'
  dev: DevOptions
  build: BuildOptions
}
```

Интерфейс `UserConfig` расширяется от интерфейса `EnvironmentOptions`, позволяя настраивать клиент и значения по умолчанию для других окружений, настраиваемых через опцию `environments`. Окружения `client` и серверное окружение с именем `ssr` всегда присутствуют во время разработки. Это позволяет обратную совместимость с `server.ssrLoadModule(url)` и `server.moduleGraph`. Во время сборки окружение `client` всегда присутствует, а окружение `ssr` присутствует только если оно явно настроено (используя `environments.ssr` или для обратной совместимости `build.ssr`). Приложению не нужно использовать имя `ssr` для его SSR-окружения, оно может назвать его `server`, например.

```ts
interface UserConfig extends EnvironmentOptions {
  environments: Record<string, EnvironmentOptions>
  // другие опции
}
```

Обратите внимание, что свойство верхнего уровня `ssr` будет устаревшим, как только API окружений станет стабильным. Эта опция имеет ту же роль, что и `environments`, но для окружения по умолчанию `ssr` и позволяет настраивать только небольшой набор опций.

## Пользовательские экземпляры окружений

Доступны низкоуровневые API конфигурации, чтобы провайдеры сред выполнения могли предоставлять окружения с правильными значениями по умолчанию для их сред выполнения. Эти окружения также могут порождать другие процессы или потоки для запуска модулей во время разработки в среде выполнения, более близкой к продакшен-окружению.

```js
import { customEnvironment } from 'vite-environment-provider'

export default {
  build: {
    outDir: '/dist/client',
  },
  environments: {
    ssr: customEnvironment({
      build: {
        outDir: '/dist/ssr',
      },
    }),
  },
}
```

## Обратная совместимость

Текущие API сервера Vite еще не устарели и обратно совместимы с Vite 5. Новый API окружений является экспериментальным.

`server.moduleGraph` возвращает смешанное представление графов модулей клиента и ssr. Будут возвращены обратно совместимые смешанные узлы модулей из всех его методов. Та же схема используется для узлов модулей, передаваемых в `handleHotUpdate`.

Мы пока не рекомендуем переключаться на API окружений. Мы стремимся к тому, чтобы значительная часть пользовательской базы приняла Vite 6, прежде чем плагинам не нужно будет поддерживать две версии. Проверьте раздел будущих breaking changes для информации о будущих устареваниях и пути обновления:

- [`this.environment` в хуках](/changes/this-environment-in-hooks)
- [Хук плагина HMR `hotUpdate`](/changes/hotupdate-hook)
- [Переход к API для каждого окружения](/changes/per-environment-apis)
- [SSR с использованием API `ModuleRunner`](/changes/ssr-using-modulerunner)
- [Общие плагины во время сборки](/changes/shared-plugins-during-build)

## Целевые пользователи

Это руководство предоставляет основные концепции об окружениях для конечных пользователей.

Авторы плагинов имеют более согласованный API для взаимодействия с текущей конфигурацией окружения. Если вы строите на основе Vite, руководство [API окружений для плагинов](./api-environment-plugins.md) описывает способ расширенных API плагинов, доступных для поддержки нескольких пользовательских окружений.

Фреймворки могут решить раскрыть окружения на разных уровнях. Если вы автор фреймворка, продолжайте читать [Руководство по API окружений для фреймворков](./api-environment-frameworks), чтобы узнать о программной стороне API окружений.

Для провайдеров сред выполнения [Руководство по API окружений для сред выполнения](./api-environment-runtimes.md) объясняет, как предложить пользовательское окружение для использования фреймворками и пользователями.
